## Copyright (C) 2007-2012 Roger While
## Copyright (C) 2014 Simon Sobisch
## 
## This file is part of GNU Cobol.
## 
## The GNU Cobol compiler is free software: you can redistribute it
## and/or modify it under the terms of the GNU General Public License
## as published by the Free Software Foundation, either version 3 of the
## License, or (at your option) any later version.
## 
## GNU Cobol is distributed in the hope that it will be useful,
## but WITHOUT ANY WARRANTY; without even the implied warranty of
## MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
## GNU General Public License for more details.
## 
## You should have received a copy of the GNU General Public License
## along with GNU Cobol.  If not, see <http://www.gnu.org/licenses/>.

### GNU Cobol Test Suite


AT_SETUP([cobc configuration])
AT_KEYWORDS([misc extensions])

AT_DATA([test.conf], [
include "default.conf"
relax-level-hierarchy: yes
])

AT_DATA([prog.cob], [
       IDENTIFICATION   DIVISION.
       PROGRAM-ID.      prog.
       DATA             DIVISION.
       WORKING-STORAGE  SECTION.
       01  A.
            05 B.
                10 C PIC X.
           04 D.
            05 E PIC X.
       PROCEDURE        DIVISION.
           STOP RUN.
])

# default configuration permits this extension
AT_CHECK([$COMPILE_ONLY prog.cob], [1], [],
[prog.cob: 9: Error: No previous data item of level 04
])

# check if override via -conf works and if include works
AT_CHECK([$COMPILE_ONLY -conf=test.conf prog.cob], [0], [],
[prog.cob: 9: Warning: No previous data item of level 04
])

# -cb_conf must override all
AT_CHECK([$COMPILE_ONLY -cb_conf=relax-level-hierarchy:no -conf=test.conf prog.cob], [1], [],
[prog.cob: 9: Error: No previous data item of level 04
])

# conf entries must be clean
AT_CHECK([$COMPILE_ONLY -cb_conf=relax-level-hierarchyno prog.cob], [1], [],
[Configuration Error
cb_conf: Invalid configuration 'relax-level-hierarchyno'
])
AT_CHECK([$COMPILE_ONLY -cb_conf=assign-clause:cobol2002 prog.cob], [1], [],
[Configuration Error
cb_conf: Unsupported value 'cobol2002' for configuration tag 'assign-clause'
])
AT_CHECK([$COMPILE_ONLY -cb_conf=assign-clause:cobol-2002 prog.cob], [1], [],
[Configuration Error
cb_conf: Invalid value 'cobol-2002' for configuration tag 'assign-clause'
])
AT_CHECK([$COMPILE_ONLY -cb_conf=include:notthere.conf prog.cob], [1], [],
[Configuration Error
cb_conf: 'include' not supported with -cb_conf
])
AT_CHECK([$COMPILE_ONLY -conf=notthere.conf prog.cob], [1], [],
[Configuration Error
notthere.conf: No such file or directory
])

AT_CLEANUP


AT_SETUP([Ambiguous AND/OR])
AT_KEYWORDS([expression])

AT_DATA([prog.cob], [
       IDENTIFICATION   DIVISION.
       PROGRAM-ID.      prog.
       PROCEDURE        DIVISION.
           IF 3 = 1 AND 2 OR 3
               DISPLAY "OK"
               END-DISPLAY
           END-IF.
           IF 3 = 1 OR 2 AND 3
               DISPLAY "NO"
               END-DISPLAY
           END-IF.
           STOP RUN.
])

AT_CHECK([$COMPILE_ONLY prog.cob], [0], [],
[prog.cob: 6: Warning: Suggest parentheses around AND within OR
prog.cob: 10: Warning: Suggest parentheses around AND within OR
])

AT_CLEANUP


AT_SETUP([Missing headers])
AT_KEYWORDS([misc])

AT_DATA([prog.cob], [
       SOURCE-COMPUTER. LINUX.
       SPECIAL-NAMES.
            SYMBOLIC NL IS 101
                     NL2   102
            NUMERIC SIGN TRAILING SEPARATE
            DECIMAL-POINT IS COMMA
            .

            SELECT PRINT-FILE ASSIGN "EXTRXW"
            ORGANIZATION LINE SEQUENTIAL
            .
       DATA DIVISION.
       FD  PRINT-FILE EXTERNAL.
       01  PRINT-REC          PIC X(64).

           DISPLAY "X"
           END-DISPLAY
           ACCEPT OMITTED
           END-ACCEPT
           GOBACK
           .
])

AT_CHECK([$COMPILE_ONLY prog.cob], [1], [],
[prog.cob: 2: Error: PROGRAM-ID header missing
prog.cob: 2: Error: ENVIRONMENT DIVISION header missing
prog.cob: 2: Error: CONFIGURATION SECTION header missing
prog.cob: 10: Error: INPUT-OUTPUT SECTION header missing
prog.cob: 10: Error: FILE-CONTROL header missing
prog.cob: 14: Error: FILE SECTION header missing
prog.cob: 17: Error: PROCEDURE DIVISION header missing
])

AT_CLEANUP


AT_SETUP([CLASS duplicate values])
AT_KEYWORDS([misc])

AT_DATA([prog.cob], [
       IDENTIFICATION   DIVISION.
       PROGRAM-ID.      prog.
       ENVIRONMENT      DIVISION.
       CONFIGURATION    SECTION.
       SPECIAL-NAMES.
            SYMBOLIC NL IS 101
                     NL2   102
            CLASS    CHECK-VALID    'a' THRU 'z'
                                    'A' THRU 'Z'
                                    'cdef'
            NUMERIC SIGN TRAILING SEPARATE
            DECIMAL-POINT IS COMMA
            .
       DATA             DIVISION.
       WORKING-STORAGE  SECTION.
       01 X             PIC X(8).
       PROCEDURE        DIVISION.
           IF X         IS CHECK-VALID
              DISPLAY "OK"
              END-DISPLAY
           END-IF.
           STOP RUN.
])

AT_CHECK([$COMPILE_ONLY prog.cob], [1], [],
[prog.cob: 9: Error: Duplicate values in class 'CHECK-VALID'
])

AT_CLEANUP


AT_SETUP([INSPECT invalid size])
AT_KEYWORDS([misc])

AT_DATA([prog.cob], [
       IDENTIFICATION   DIVISION.
       PROGRAM-ID.      prog.
       DATA             DIVISION.
       WORKING-STORAGE  SECTION.
       01 X             PIC X(8).
       PROCEDURE        DIVISION.
           INSPECT X REPLACING ALL SPACES BY "AA".
           INSPECT X REPLACING ALL "ABC"  BY "AA".
           INSPECT X REPLACING ALL "DEF"  BY SPACES.
           INSPECT X CONVERTING SPACES TO "AA".
           INSPECT X CONVERTING "ABC"  TO "AA".
           INSPECT X CONVERTING "DEF"  TO SPACES.
           STOP RUN.
])

AT_CHECK([$COMPILE_ONLY prog.cob], [1], [],
[prog.cob: 8: Error: REPLACING operands differ in size
prog.cob: 9: Error: REPLACING operands differ in size
prog.cob: 11: Error: CONVERTING operands differ in size
prog.cob: 12: Error: CONVERTING operands differ in size
])

AT_CLEANUP


AT_SETUP([INSPECT invalid target])
AT_KEYWORDS([misc])

AT_DATA([prog.cob], [
       IDENTIFICATION   DIVISION.
       PROGRAM-ID.      prog.
       DATA             DIVISION.
       WORKING-STORAGE  SECTION.
       01 X             PIC X(8).
       PROCEDURE        DIVISION.
           INSPECT FUNCTION TRIM(X) REPLACING ALL "ABC" BY "DEF".
           INSPECT FUNCTION TRIM(X) CONVERTING "ABC" TO "AAA".
           STOP RUN.
])

AT_CHECK([$COMPILE_ONLY prog.cob], [1], [],
[prog.cob: 8: Error: Invalid target for REPLACING
prog.cob: 9: Error: Invalid target for CONVERTING
])

AT_CLEANUP


AT_SETUP([INSPECT missing keyword])
AT_KEYWORDS([misc])

AT_DATA([prog.cob], [
       IDENTIFICATION   DIVISION.
       PROGRAM-ID.      prog.
       DATA             DIVISION.
       WORKING-STORAGE  SECTION.
       01 X             PIC X(8).
       PROCEDURE        DIVISION.
           INSPECT X REPLACING "AB" BY "CD".
           STOP RUN.
])

AT_CHECK([$COMPILE_ONLY prog.cob], [1], [],
[prog.cob: 8: Error: INSPECT missing a keyword
])

AT_CLEANUP


AT_SETUP([Maximum data size])
AT_KEYWORDS([misc])

AT_DATA([prog.cob], [
       IDENTIFICATION   DIVISION.
       PROGRAM-ID.      prog.
       DATA             DIVISION.
       WORKING-STORAGE  SECTION.
       01 SINGLE-ITEM   PIC X(999999999).
       01 GROUP-ITEM1.
          05 FILLER     PIC X(999999999).
       01 GROUP-ITEM2.
          05 FILLER     PIC X(199999999).
          05 FILLER     PIC X(199999999).
       PROCEDURE        DIVISION.
           STOP RUN.

])

AT_CHECK([$COMPILE_ONLY prog.cob], [1], [],
[prog.cob: 6: Error: 'SINGLE-ITEM' cannot be larger than 268435456 bytes
prog.cob: 8: Error: 'FILLER 1' cannot be larger than 268435456 bytes
prog.cob: 7: Error: 'GROUP-ITEM1' cannot be larger than 268435456 bytes
prog.cob: 9: Error: 'GROUP-ITEM2' cannot be larger than 268435456 bytes
])

AT_CLEANUP


AT_SETUP([Unreachable statement])
AT_KEYWORDS([misc extensions])

AT_DATA([prog.cob], [
       IDENTIFICATION   DIVISION.
       PROGRAM-ID.      prog.
       ENVIRONMENT DIVISION.
       INPUT-OUTPUT SECTION.
       FILE-CONTROL.
           SELECT f ASSIGN TO 'f' LINE SEQUENTIAL.
       DATA DIVISION.
       FILE SECTION.
       FD  f.
       01  f-rec PIC X.
       WORKING-STORAGE  SECTION.
       PROCEDURE        DIVISION.
       DECLARATIVES.
       f-error SECTION.
           USE AFTER ERROR ON f.
           GOBACK
           .
       END DECLARATIVES.

           DISPLAY "VALID"
           END-DISPLAY.

       P01.
           GO TO P02.
           DISPLAY "INVALID"
           END-DISPLAY.
       P02.
           STOP RUN.
])

AT_CHECK([$COMPILE_ONLY -Wunreachable prog.cob], [0], ,
[prog.cob: In paragraph 'P01':
prog.cob: 26: Warning: Unreachable statement 'DISPLAY'
])

AT_CLEANUP


AT_SETUP([REPOSITORY])
AT_KEYWORDS([misc])

AT_DATA([prog.cob], [
       IDENTIFICATION   DIVISION.
       PROGRAM-ID.      prog.
       ENVIRONMENT DIVISION.
       CONFIGURATION SECTION.
       SPECIAL-NAMES.
       REPOSITORY.
           FUNCTION rxwfun
           FUNCTION pi e intrinsic
           .
       DATA             DIVISION.
       WORKING-STORAGE  SECTION.
       PROCEDURE        DIVISION.
           DISPLAY PI.
           DISPLAY E.
           STOP RUN.
])

AT_CHECK([$COMPILE_ONLY prog.cob], [0], [], [])

AT_CLEANUP


AT_SETUP([CRT STATUS])
AT_KEYWORDS([SPECIAL-NAMES misc])

AT_DATA([prog.cob], [
       IDENTIFICATION   DIVISION.
       PROGRAM-ID.      prog.
       ENVIRONMENT DIVISION.
       CONFIGURATION SECTION.
       SPECIAL-NAMES.
           CRT STATUS IS MY-CRT-STATUS.
       DATA             DIVISION.
       WORKING-STORAGE  SECTION.
       01 X             PIC X.
       PROCEDURE        DIVISION.
           ACCEPT X END-ACCEPT.
           STOP RUN.
])

AT_DATA([prog2.cob], [
       IDENTIFICATION   DIVISION.
       PROGRAM-ID.      prog2.
       ENVIRONMENT DIVISION.
       CONFIGURATION SECTION.
       SPECIAL-NAMES.
           CRT STATUS IS MY-CRT-STATUS.
       DATA             DIVISION.
       WORKING-STORAGE  SECTION.
       01 X             PIC X.
       77 MY-CRT-STATUS PIC 9(04).
       PROCEDURE        DIVISION.
           ACCEPT X END-ACCEPT.
           STOP RUN.
])

AT_CHECK([$COMPILE_ONLY prog.cob], [1], [],
[prog.cob: 7: Error: 'MY-CRT-STATUS' is not defined
])
AT_CHECK([$COMPILE_ONLY prog2.cob], [0])

AT_CLEANUP


AT_SETUP([ACCEPT WITH ( NO ) UPDATE / DEFAULT])
AT_KEYWORDS([misc extensions])

AT_DATA([prog.cob], [
       IDENTIFICATION   DIVISION.
       PROGRAM-ID.      prog.
       ENVIRONMENT DIVISION.
       CONFIGURATION SECTION.
       DATA             DIVISION.
       WORKING-STORAGE  SECTION.
       01 X             PIC X.
       PROCEDURE        DIVISION.
           ACCEPT X                 END-ACCEPT.
           ACCEPT X WITH    UPDATE  END-ACCEPT.
           ACCEPT X WITH    DEFAULT END-ACCEPT.
           ACCEPT X WITH NO UPDATE  END-ACCEPT.
           ACCEPT X WITH NO DEFAULT END-ACCEPT.
           STOP RUN.
])

AT_CHECK([$COMPILE_ONLY -cb_conf=accept-update:yes prog.cob], [0], [], [])

AT_CLEANUP


AT_SETUP([ACCEPT WITH AUTO / TAB])
AT_KEYWORDS([AUTO-SKIP AUTOTERMINATE misc extensions])

AT_DATA([prog.cob], [
       IDENTIFICATION   DIVISION.
       PROGRAM-ID.      prog.
       ENVIRONMENT DIVISION.
       CONFIGURATION SECTION.
       DATA             DIVISION.
       WORKING-STORAGE  SECTION.
       01 X             PIC X.
       PROCEDURE        DIVISION.
           ACCEPT X                       END-ACCEPT.
           ACCEPT X WITH    AUTO          END-ACCEPT.
           ACCEPT X WITH    AUTO-SKIP     END-ACCEPT.
           ACCEPT X WITH    AUTOTERMINATE END-ACCEPT.
           ACCEPT X WITH    TAB           END-ACCEPT.
           STOP RUN.
])

AT_CHECK([$COMPILE_ONLY -cb_conf=accept-auto:yes prog.cob], [0], [], [])

AT_CLEANUP


AT_SETUP([Line and floating comments])
AT_KEYWORDS([misc extensions])

AT_DATA([prog.cob], [
       IDENTIFICATION   DIVISION.
       PROGRAM-ID.      prog.
       ENVIRONMENT DIVISION.
       CONFIGURATION SECTION.
       DATA             DIVISION.
       WORKING-STORAGE  SECTION.
       PROCEDURE        DIVISION.
      *    DISPLAY 'COMMENT'             END-DISPLAY
      /    DISPLAY 'COMMENTSLASH'        END-DISPLAY
*          DISPLAY 'MFCOMMENTASTERISK'   END-DISPLAY
/          DISPLAY 'MFCOMMENTSLASH'      END-DISPLAY
 *         DISPLAY 'NOMFCOMMENTASTERISK' END-DISPLAY
 /         DISPLAY 'NOMFCOMMENTSLASH'    END-DISPLAY
        *> DISPLAY 'FLOATING'            END-DISPLAY
 *>        DISPLAY 'NOFLOATING'          END-DISPLAY
           STOP RUN.
])

AT_DATA([prog2.cob], [
       IDENTIFICATION   DIVISION.
       PROGRAM-ID.      prog2.
       ENVIRONMENT DIVISION.
       CONFIGURATION SECTION.
       DATA             DIVISION.
       WORKING-STORAGE  SECTION.
       PROCEDURE        DIVISION.
      *    DISPLAY 'COMMENT'             END-DISPLAY
      /    DISPLAY 'COMMENTSLASH'        END-DISPLAY
      $    DISPLAY 'COMMENTDOLLAR'       END-DISPLAY
*          DISPLAY 'MFCOMMENTASTERISK'   END-DISPLAY
/          DISPLAY 'MFCOMMENTSLASH'      END-DISPLAY
 *         DISPLAY 'NOMFCOMMENTASTERISK' END-DISPLAY
 /         DISPLAY 'NOMFCOMMENTSLASH'    END-DISPLAY
        *> DISPLAY 'FLOATING'            END-DISPLAY
        |  DISPLAY 'ACUFLOATING'         END-DISPLAY
 |         DISPLAY 'NOACUFLOATING'       END-DISPLAY
 *>        DISPLAY 'NOFLOATING'          END-DISPLAY
           STOP RUN.
])

AT_DATA([prog3.cob], [
IDENTIFICATION   DIVISION.
PROGRAM-ID.      prog3.
ENVIRONMENT DIVISION.
CONFIGURATION SECTION.
DATA             DIVISION.
WORKING-STORAGE  SECTION.
PROCEDURE        DIVISION.
      * DISPLAY 'NOCOMMENT'           END-DISPLAY
      / DISPLAY 'NOCOMMENTSLASH'      END-DISPLAY
      $ DISPLAY 'NOCOMMENTDOLLAR'     END-DISPLAY
*       DISPLAY 'NOMFCOMMENTASTERISK' END-DISPLAY
/       DISPLAY 'NOMFCOMMENTSLASH'    END-DISPLAY
 |      DISPLAY 'ACUFLOATING'         END-DISPLAY
 *>     DISPLAY 'FLOATING'            END-DISPLAY
        STOP RUN.
])

AT_CHECK([$COMPILE prog.cob], [0], [], [])

AT_CHECK([./prog], [0],
[MFCOMMENTASTERISK
MFCOMMENTSLASH
NOMFCOMMENTASTERISK
NOMFCOMMENTSLASH
NOFLOATING
], [])

AT_CHECK([$COMPILE_ONLY prog2.cob], [1], [],
[prog2.cob: 11: Error: Invalid indicator '$' at column 7
])


AT_CHECK([$COMPILE -fmfcomment prog.cob], [0], [],
[])

AT_CHECK([./prog], [0],
[NOMFCOMMENTASTERISK
NOMFCOMMENTSLASH
NOFLOATING
], [])

AT_CHECK([$COMPILE_ONLY -fmfcomment prog2.cob], [1], [],
[prog2.cob: 11: Error: Invalid indicator '$' at column 7
])


AT_CHECK([$COMPILE -facucomment prog.cob], [0], [], [])

AT_CHECK([./prog], [0],
[MFCOMMENTASTERISK
MFCOMMENTSLASH
NOMFCOMMENTASTERISK
NOMFCOMMENTSLASH
NOFLOATING
], [])

AT_CHECK([$COMPILE -facucomment prog2.cob], [0], [], [])

AT_CHECK([./prog2], [0],
[MFCOMMENTASTERISK
MFCOMMENTSLASH
NOMFCOMMENTASTERISK
NOMFCOMMENTSLASH
NOACUFLOATING
NOFLOATING
], [])


AT_CHECK([$COMPILE_ONLY -free prog3.cob], [1], [],
[prog3.cob: 11: Warning: Spurious '$' detected - ignoring
prog3.cob: 9: Error: syntax error, unexpected *
prog3.cob: 9: Error: syntax error, unexpected Literal
prog3.cob: 10: Error: syntax error, unexpected /
prog3.cob: 10: Error: syntax error, unexpected Literal
prog3.cob: 12: Error: syntax error, unexpected *
prog3.cob: 12: Error: syntax error, unexpected Literal
prog3.cob: 13: Error: syntax error, unexpected /
prog3.cob: 13: Error: syntax error, unexpected Literal
prog3.cob: 14: Error: Invalid symbol: | - Skipping word
])
AT_CHECK([$COMPILE_ONLY -free -fmfcomment prog3.cob], [1], [],
[prog3.cob: 11: Warning: Spurious '$' detected - ignoring
prog3.cob: 9: Error: syntax error, unexpected *
prog3.cob: 9: Error: syntax error, unexpected Literal
prog3.cob: 10: Error: syntax error, unexpected /
prog3.cob: 10: Error: syntax error, unexpected Literal
prog3.cob: 12: Error: syntax error, unexpected *
prog3.cob: 12: Error: syntax error, unexpected Literal
prog3.cob: 13: Error: syntax error, unexpected /
prog3.cob: 13: Error: syntax error, unexpected Literal
prog3.cob: 14: Error: Invalid symbol: | - Skipping word
])
AT_CHECK([$COMPILE_ONLY -free -facucomment prog3.cob], [1], [],
[prog3.cob: 11: Warning: Spurious '$' detected - ignoring
prog3.cob: 9: Error: syntax error, unexpected *
prog3.cob: 9: Error: syntax error, unexpected Literal
prog3.cob: 10: Error: syntax error, unexpected /
prog3.cob: 10: Error: syntax error, unexpected Literal
prog3.cob: 12: Error: syntax error, unexpected *
prog3.cob: 12: Error: syntax error, unexpected Literal
prog3.cob: 13: Error: syntax error, unexpected /
prog3.cob: 13: Error: syntax error, unexpected Literal
])

AT_CLEANUP

