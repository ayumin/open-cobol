## Copyright (C) 2014 Simon Sobisch
## 
## This file is part of GNU Cobol.
## 
## The GNU Cobol compiler is free software: you can redistribute it
## and/or modify it under the terms of the GNU General Public License
## as published by the Free Software Foundation, either version 3 of the
## License, or (at your option) any later version.
## 
## GNU Cobol is distributed in the hope that it will be useful,
## but WITHOUT ANY WARRANTY; without even the implied warranty of
## MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
## GNU General Public License for more details.
## 
## You should have received a copy of the GNU General Public License
## along with GNU Cobol.  If not, see <http://www.gnu.org/licenses/>.
 
### GNU Cobol Test Suite
 
### ISO+IEC+1989-2002 REPORT WRITER module

AT_SETUP([Check REPORT error/warning])
AT_KEYWORDS([report])

AT_DATA([prog.cob], [
       IDENTIFICATION   DIVISION.
       PROGRAM-ID. prog.
       ENVIRONMENT      DIVISION.
       INPUT-OUTPUT     SECTION.
       FILE-CONTROL.
           SELECT TRANSACTION-DATA
           ASSIGN TO EXTERNAL DATAIN
           ORGANIZATION IS LINE SEQUENTIAL.
           
           SELECT REPORT-FILE
           ASSIGN TO EXTERNAL LINE ADVANCING SYSPRINT.

       DATA             DIVISION.
       FILE             SECTION.
       FD TRANSACTION-DATA
          LABEL RECORDS ARE OMITTED
          BLOCK CONTAINS 0 RECORDS
          RECORD CONTAINS 80 CHARACTERS
          DATA RECORD IS TRANSACTION-RECORD.
       01 TRANSACTION-RECORD.
          03 TR-CUSTOMER-NUMBER     PIC 9(04).
          03 FILLER                 PIC X(01).
          03 TR-CUSTOMER-NAME       PIC X(16).
          03 FILLER                 PIC X(01).
          03 TR-ITEM-NUMBER         PIC 9(05).
          03 FILLER                 REDEFINES TR-ITEM-NUMBER.
             05 TR-ITEM-DEPARTMENT  PIC 9(01).
             05 FILLER              PIC 9(04).
          03 FILLER                 PIC X(01).
          03 TR-ITEM-COST           PIC 9(03)V99.
          03 FILLER                 PIC X(47).
       FD REPORT-FILE
          LABEL RECORDS ARE OMITTED
          REPORT IS NO-REPORT.
       WORKING-STORAGE  SECTION.
       01 END-OF-FILE-SWITCH        PIC X(1)    VALUE 'N'.
          88 END-OF-FILE            VALUE 'Y'.
      
       REPORT           SECTION.
       RD NO-REPORT
          PAGE LIMIT IS 66 LINES
          HEADING 1
          FIRST DETAIL 5
          LAST DETAIL 58.
      
       01 PAGE-HEAD-GROUP TYPE PAGE HEADING.
          02 LINE 1.
             03 COLUMN 27   PIC X(41) VALUE
                'S A M P L E  R E P O R T'.
          02 LINE PLUS 2.
             03 COLUMN 01   PIC X(09) VALUE 'CUST. NO.'.
             03 COLUMN 15   PIC X(10) VALUE 'CUST. NAME'.
             03 COLUMN 30   PIC X(05) VALUE 'DEPT.'.
             03 COLUMN 39   PIC X(08) VALUE 'ITEM NO.'.
             03 COLUMN 51   PIC X(09) VALUE 'ITEM COST'.
      
       01 CHARGE-DETAIL TYPE DETAIL.
          02 LINE PLUS 1.
             03 COLUMN 03   PIC Z(04) SOURCE TR-CUSTOMER-NUMBER.
             03 COLUMN 10   PIC X(16) SOURCE TR-CUSTOMER-NAME.
             03 COLUMN 32   PIC 9(01) SOURCE TR-ITEM-DEPARTMENT.
             03 COLUMN 40   PIC 9(05) SOURCE TR-ITEM-NUMBER.
             03 COLUMN 51   PIC $$$$.99 SOURCE TR-ITEM-COST.

       PROCEDURE        DIVISION.
      
           OPEN INPUT TRANSACTION-DATA,
                OUTPUT REPORT-FILE.
      
           INITIATE CUSTOMER-REPORT.
      
           READ TRANSACTION-DATA
               AT END
                   MOVE 'Y' TO END-OF-FILE-SWITCH 
           END-READ.
      
           PERFORM UNTIL FOREVER
              GENERATE CHARGE-DETAIL
              READ TRANSACTION-DATA
                  AT END
                     EXIT PERFORM
              END-READ
           END-PERFORM.
      
           TERMINATE CUSTOMER-REPORT.
      
           CLOSE TRANSACTION-DATA,
                 REPORT-FILE.
      
           STOP RUN.
])

AT_CHECK([$COMPILE_ONLY -std=mf -Wall prog.cob], [1], [],
[prog.cob: 16: Warning: LABEL RECORDS is obsolete in Micro Focus COBOL
prog.cob: 18: Warning: RECORD clause ignored for LINE SEQUENTIAL
prog.cob: 19: Warning: DATA RECORDS is obsolete in Micro Focus COBOL
prog.cob: 33: Warning: LABEL RECORDS is obsolete in Micro Focus COBOL
prog.cob: 70: Error: 'CUSTOMER-REPORT' is not defined
prog.cob: 70: Error: 'CUSTOMER-REPORT' is not a valid report name
prog.cob: 77: Error: syntax error, unexpected FOREVER
prog.cob: 78: Error: syntax error, unexpected Identifier
prog.cob: 79: Error: syntax error, unexpected Identifier
prog.cob: 82: Error: syntax error, unexpected END-READ
prog.cob: 85: Error: 'CUSTOMER-REPORT' is not defined
prog.cob: 85: Error: 'CUSTOMER-REPORT' is not a valid report name
])

AT_CLEANUP


AT_SETUP([REPORT not positive integers in COL / LINE [PLUS]])
AT_KEYWORDS([report])

AT_DATA([prog.cob], [
       IDENTIFICATION DIVISION.
       PROGRAM-ID. prog.

       ENVIRONMENT DIVISION.
       INPUT-OUTPUT SECTION.
       FILE-CONTROL.
       SELECT out-file ASSIGN "blah.txt"
           ORGANIZATION LINE SEQUENTIAL.

       DATA DIVISION.
       FILE SECTION.
       FD  out-file REPORT rp.

       REPORT SECTION.
       RD  rp.
       01  rp-head TYPE PH.
          02  LINE 1, COL 0 VALUE "Hello!".
          02  LINE 2, COL 2 VALUE "Hello!".
          02  LINE PLUS 0.
              03 COLUMN 01      PIC X(09) VALUE 'CUST. NO.'.
              03 COLUMN PLUS 0  PIC X(09) VALUE 'ITEM'.
          02  LINE PLUS zero.
              03 COLUMN 1.5     PIC X(09) VALUE 'CUST. NO.'.
              03 COLUMN + -10   PIC X(09) VALUE 'ITEM'.


       PROCEDURE DIVISION.
           OPEN OUTPUT out-file
           INITIATE rp
           GENERATE rp-detail
           TERMINATE rp
           CLOSE out-file
           STOP RUN.
])

AT_CHECK([$COMPILE_ONLY -std=mf -Wall prog.cob], [1], [],
[prog.cob: 17: Error: Invalid COLUMN integer; Must be > 0
prog.cob: 19: Warning: LINE PLUS 0 not implemented
prog.cob: 22: Warning: LINE PLUS 0 not implemented
prog.cob: 23: Error: Positive Integer value expected
prog.cob: 24: Error: Positive Integer value expected
prog.cob: 12: Warning: NO DETAIL line defined in report rp
prog.cob: 30: Error: 'rp-detail' is not defined
])

AT_CLEANUP

